(function(){"use strict";new Janfish_DataPost({el:"#app",data:{tips:"",postMode:true,circles:[],successTips:"登录成功",api:{post:"/index"},formData:{username:"administrator",password:"",remember:"0"},validation:{username:[{required:true,message:"姓名不能为空",trigger:"blur"}],password:[{required:true,message:"密码不能为空",trigger:"blur"}]}},methods:{qr:function(){var a=this,b,c=15e3,d,e="ws://socket.janfish.cn:8292/",f=new WebSocket(e);a.tips="二维码生成中...";a.onerror=false;f.onopen=function(a){f.send('{"EVENT":"Login","DATA":{"verify_api":"http://'+document.domain+'/qr/verify","bind_api":"http://'+document.domain+'/qr/bind"}}')};f.onerror=function(c){a.onerror=true;a.tips='连接失败，请尝试<span onclick="vue.qr()">重新</span>连接';clearInterval(b);f=null};f.onclose=function(c){if(a.onerror===false){clearInterval(b);f=null;a.tips='二维码超时失效，请<span onclick="vue.qr()">重新</span>生成'}};f.onmessage=function(b){if(b.data){var c=JSON.parse(b.data),e=7,f="L",g,h,i;if(!c.data){return false}c=c.data;if(c.EVENT==="Login"&&c.ACTION==="Response"){a.$user.setInfo(c.DATA.id,c.DATA.name,c.DATA.access_token,null);a.tips="验证通过，登陆中.....";setTimeout(function(){d=a.$user.getLastUrl(location.href);location.href=d?d:"/"},1200)}else if(c.EVENT==="Login"&&c.ACTION==="Index"){g=qrcode(e,f);h=document.getElementById("qr-image");i="http://token.janfish.cn/wechat/authorize?state=wechatsso&scope=snsapi_userinfo&token="+c.DATA.uid;g.addData(i);g.make();h.innerHTML=g.createImgTag(8,0);a.tips="请使用微信扫一扫登录"}}};b=setInterval(function(){if(f&&f.readyState==1){f.send('{"EVENT":"health","ACTION":"pong"}')}else{clearInterval(b)}},c)},afterPost:function(a){var b=this,c;if(a["id"]&&a["access_token"]){this.$user.setInfo(a["id"],a["name"],a["access_token"],this.formData.remember=="1"?7776e3:null)}setTimeout(function(){c=b.$user.getLastUrl(location.href);location.href=c?c:a["jump_url"]},400)}},mounted:function(){if(this.$user.getAccessToken()){location.href=this.$user.getLastUrl()?this.$user.getLastUrl():"/main";return false}this.qr()}})})();