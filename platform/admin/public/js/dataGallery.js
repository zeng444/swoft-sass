(function(){"use strict";var a,b;a=Janfish.extend({data:function(){return{api:{search:"",post:"",remove:""},saveDefaultAttributes:{},columnSpan:3,displayAttributes:{sourceImage:"image",preview:"thumbnail",otherField:["id"]},editMode:false,selectAllState:false,selectAllCheckbox:false,count:0,page:1,pageSize:10,searchFilter:{},data:[],previewModal:{show:false,title:"",url:""},uploadModal:{show:false,title:"批量上传"},successTips:"提交成功",uploadedFiles:[],dataChanged:false}},watch:{data:{handler:function(){if(this.editMode){this.dataChanged=true}},deep:true}},methods:{__arrayMerge:function(a,b){var c;for(c in b){a[c]=b[c]}return a},beforePost:function(a){return a},closeUploadPanel:function(){this.uploadedFiles=[];this.$refs.upfile.clearFiles()},postNewData:function(){var a=this;if(a.uploadedFiles.length==0){return false}a.$http.post(a.api.post,JSON.stringify(a.beforePost(a.uploadedFiles))).then(function(b){if(b.status!=="success"){a.$Message.error(b.message);return false}a.uploadedFiles=[];a.$Message.success(a.successTips);a.closeUploadPanel();a.loadList(1,a.pageSize)})},afterDataLoad:function(a){for(b in a.data){a.data[b].checked=false}return a},upload:function(){this.uploadModal.show=true},preview:function(a){this.previewModal.show=true;this.previewModal.title=this.displayAttributes.otherField[0]?a[this.displayAttributes.otherField[0]]:"图片预览";if(a[this.displayAttributes.sourceImage]){this.previewModal.url=appConfig.imagePrefix+a[this.displayAttributes.sourceImage]}},pickItems:function(){this.selectAllState=!this.selectAllState;for(b in this.data){this.data[b].checked=this.selectAllState}},pickItem:function(a){if(this.editMode){a.checked=!a.checked}},remoteSave:function(){var a=this;if(this.dataChanged){a.$http.post(a.api.post,JSON.stringify(a.data)).then(function(b){if(b.status!=="success"){a.$Message.error(b.message);return false}a.$Message.success(a.successTips);a.selectAllCheckbox=false;a.selectAllState=false;a.dataChanged=false;a.switchMode();a.afterPost()})}else{a.selectAllCheckbox=false;a.selectAllState=false;a.dataChanged=false;a.switchMode()}},switchMode:function(){this.editMode=!this.editMode;for(b in this.data){this.data[b].checked=false}},resetFilter:function(){for(b in this.searchFilter){this.searchFilter[b]=""}},afterPost:function(){},onUploadSuccess:function(a){if(a.status==="success"){var c={};c[this.displayAttributes.sourceImage]=a.data.data[0].name;c[this.displayAttributes.preview]=a.data.data[0].name;for(b in this.displayAttributes.otherField){c[this.displayAttributes.otherField[b]]=a.data.data[0].name}this.uploadedFiles.push(this.__arrayMerge(c,this.saveDefaultAttributes))}},listPostData:function(a){return a},loadList:function(a,b){var c=this,d;c.page=a;c.pageSize=b;c.searchFilter.page=a;c.searchFilter.pageSize=b;d=c.api.search;c.$http.post(d,qs.stringify(c.listPostData(c.searchFilter))).then(function(a){if(a.code!=="200"){c.$Message.error(a.message);return false}var b=c.afterDataLoad(a.data);c.data=b.data;c.count=b.count})},pageChange:function(a){this.loadList(a,this.pageSize)},sizeChange:function(a){this.pageSize=a;this.loadList(1,this.pageSize)},removeBatch:function(){var a=this,c=[];for(b in this.data){if(this.data[b].checked===true){c.push(this.data[b].id)}}if(c.length==0){a.$Message.error("你没有任何选择");return false}this.$Modal.confirm({title:"提示信息",content:"您确定要删除Id为 <strong>"+c.join("</strong>,<strong>")+"</strong> 的记录吗",onOk:function(){a.$http.post(a.api.remove,qs.stringify({id:c})).then(function(b){if(b.code!=="200"){a.$Message.error(b.message);return false}a.selectAllState=false;a.selectAllCheckbox=false;a.$Message.success("操作成功");a.loadList(a.page,a.pageSize)})},onCancel:function(){return false}})}},mounted:function(){this.loadList(this.page,this.pageSize)}});window.Janfish_DataGallery=a})();